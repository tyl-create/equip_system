<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¨­å‚™å€Ÿé‚„ç³»çµ± (V14.2) å‹•æ…‹æ•™å­¸</title>
    <style>
        /* --- 1. æ¨£å¼å®šç¾© --- */
        :root {
            --color-header: #2C3E50;
            --color-sidebar: #34495E;
            --color-bg: #ECF0F1;
            --color-card: #FFFFFF;
            --color-accent: #E67E22;
            --color-success: #27AE60;
            --color-logout: #E74C3C;
            --color-edit: #8E44AD;
            --color-text-dark: #2C3E50;
            --color-hint-normal: #F1C40F;
            --color-welcome: #2ECC71;
            --color-select-bg: #2980B9;
            
            --tab-inactive-bg: #BDC3C7;
            --tab-active-bg: #FFFFFF;
            --tab-active-fg: #E67E22;

            --scroll-bg: #34495E;
            --scroll-track: #ECF0F1;
            --scroll-active: #5D6D7E;
            
            --font-main: "Microsoft JhengHei UI", "Segoe UI", sans-serif;
            --font-signature: "Segoe UI", sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- å®¢è£½åŒ–æ²è»¸ --- */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-bg); border: 2px solid var(--scroll-track); }
        ::-webkit-scrollbar-thumb:hover { background: var(--scroll-active); }

        /* é€šç”¨æŒ‰éˆ• */
        .btn {
            border: none;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.1s;
            border-radius: 0;
            font-size: 14px;
            font-family: var(--font-main);
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { opacity: 1; }
        .btn:disabled { background-color: #95A5A6; cursor: not-allowed; opacity: 0.7; }
        
        .btn-accent { background-color: var(--color-accent); color: white; }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-edit { background-color: var(--color-edit); color: white; }
        .btn-blue { background-color: #3498DB; color: white; }
        .btn-logout { background-color: var(--color-logout); color: white; width: 100%; font-size: 14px; font-weight: bold; padding: 10px; }

        /* --- 2. ç™»å…¥ç•«é¢ --- */
        #login-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-header);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        .login-box { text-align: center; color: white; }
        .login-title { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
        .scan-hint { font-size: 24px; color: var(--color-hint-normal); font-weight: bold; margin-bottom: 20px; }
        .scan-input { font-size: 20px; padding: 10px; width: 320px; border: none; background: white; text-align: center; outline: none; margin-bottom: 30px; }
        .tutorial-start-btn { background: transparent; border: 1px solid #7F8C8D; color: #BDC3C7; padding: 8px 16px; cursor: pointer; font-size: 13px; margin-top: 20px; }
        .tutorial-start-btn:hover { color: white; border-color: white; }

        /* --- 3. ä¸»ä»‹é¢ --- */
        #main-app { display: none; height: 100%; flex-direction: column; }

        header {
            background-color: var(--color-header);
            color: white;
            height: 100px;
            display: flex;
            align-items: center;
            padding: 0 30px;
            flex-shrink: 0;
            position: relative;
        }
        .header-content { display: flex; align-items: center; width: 100%; }
        .user-info { font-size: 18px; font-weight: bold; color: var(--color-welcome); margin-left: 20px;}

        .container-main { flex: 1; display: flex; flex-direction: column; padding: 20px; background-color: var(--color-bg); overflow: hidden; }

        /* Tabs */
        .tabs-nav { display: flex; background-color: var(--color-bg); padding-bottom: 0; margin-bottom: 0; }
        .tab-btn {
            padding: 8px 20px;
            background: var(--tab-inactive-bg);
            border: none;
            color: var(--color-text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 2px;
            border-radius: 3px 3px 0 0;
            position: relative;
            top: 2px;
        }
        .tab-btn.active {
            background-color: var(--tab-active-bg);
            color: var(--tab-active-fg);
            top: 0;
            z-index: 2;
            padding-bottom: 10px;
        }

        .tab-content { display: none; flex: 1; background-color: var(--color-bg); padding-top: 15px; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Borrow UI */
        .borrow-split { display: flex; flex: 1; min-height: 0; }
        .category-list { width: 220px; background-color: var(--color-sidebar); color: white; overflow-y: auto; display: flex; flex-direction: column; padding: 10px; }
        .cat-item { padding: 5px 10px; cursor: pointer; font-size: 16px; color: white; margin-bottom: 2px; }
        .cat-item:hover { background-color: rgba(255,255,255,0.1); }
        .cat-item.selected { background-color: var(--color-accent); color: white; }

        .items-area-wrapper { flex: 1; background-color: var(--color-bg); padding-left: 0; display: flex; flex-direction: column; }
        .items-area { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; }
        .item-card {
            background-color: var(--color-card); color: var(--color-text-dark); width: 150px; height: 70px;
            padding: 5px; display: flex; align-items: center; justify-content: center; text-align: center;
            cursor: pointer; font-size: 13px; transition: background 0.1s;
        }
        .item-card:hover { background-color: #D6EAF8; }

        /* Cart */
        .cart-container { height: 220px; background: white; margin-top: 15px; padding: 10px; display: flex; flex-direction: column; }
        .cart-label { font-weight: bold; color: var(--color-text-dark); margin-bottom: 5px; font-size: 14px; }
        .cart-inner { flex: 1; display: flex; gap: 10px; overflow: hidden; }
        .cart-table-wrap { flex: 1; overflow-y: auto; border: none; background: white; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        .data-table th { background-color: var(--color-sidebar); color: white; padding: 8px 5px; position: sticky; top: 0; text-align: center; font-weight: bold; }
        .data-table td { padding: 8px 5px; text-align: center; color: var(--color-text-dark); border-bottom: 1px solid #f0f0f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .data-table tr.selected-row { background-color: var(--color-select-bg) !important; }
        .data-table tr.selected-row td { color: var(--color-card) !important; }

        .cart-actions { width: 120px; display: flex; flex-direction: column; gap: 5px; padding-top: 0; }
        .btn-cart-confirm { background-color: var(--color-accent); color: white; height: 60px; font-size: 16px; font-weight: bold; }
        .btn-cart-note { background-color: #3498DB; color: white; height: 30px; }

        /* Return UI */
        .return-controls { padding: 10px 0; display: flex; justify-content: flex-start; align-items: center; gap: 10px;}
        .return-table-wrap { flex: 1; overflow-y: auto; background: white; }
        .overdue { color: red !important; }
        
        /* Footer */
        .footer { margin-top: 20px; display: flex; flex-direction: column; gap: 5px; }
        .signature { font-family: var(--font-signature); font-style: italic; font-size: 12px; color: #95A5A6; text-align: right; padding-right: 5px; }

        /* Tooltip & Modals */
        .tutorial-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 9000; display: none; 
            pointer-events: auto; 
        }
        
        .highlight-target { 
            position: relative; 
            z-index: 9001 !important; 
            box-shadow: 0 0 0 3px var(--color-hint-normal) !important; 
            pointer-events: auto !important; 
        }
        
        .tooltip-box {
            position: absolute; background: white; padding: 15px; width: 300px;
            border-left: 5px solid var(--color-accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9002; display: none;
        }
        .tooltip-title { color: var(--color-header); font-weight: bold; margin-bottom: 5px; }
        .tooltip-text { font-size: 14px; line-height: 1.4; color: #333; margin-bottom: 10px; }
        .tooltip-btn { float: right; background: var(--color-header); color: white; padding: 5px 10px; font-size: 12px; border:none; cursor: pointer;}

        /* Modal é€šç”¨æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9400; display: none; }
        .modal-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; width: 300px; border-radius: 5px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 9500; display: none;
        }
        .modal-box h3 { margin-top:0; color:var(--color-header); }
        .modal-box input { width: 100%; padding: 8px; margin: 10px 0; font-size: 16px; border: 1px solid #ccc; }
        .modal-footer { display:flex; justify-content:space-between; margin-top: 10px; }
        .modal-footer button { width: 48%; }

    </style>
</head>
<body>

    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">æ™ºæ…§è¨­å‚™å€Ÿé‚„ç³»çµ±</div>
            <div class="login-ver">V14.2 æœ€çµ‚å…¸è—ç‰ˆ</div>
            <br>
            <div class="scan-hint">è«‹æƒæèº«åˆ†æ¢ç¢¼</div>
            <input type="text" class="scan-input" id="loginInput" placeholder="" autocomplete="off">
            <button class="tutorial-start-btn" onclick="startTutorial()">ğŸ“ å•Ÿå‹•æ–°æ‰‹æ•™å­¸æ¨¡å¼</button>
        </div>
    </div>

    <!-- 2. ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="main-app">
        <header>
            <div class="header-content">
                <div class="user-info" id="welcomeMsg">æ­¡è¿ï¼Œè³‡è¨Šéƒ¨ - User</div>
            </div>
        </header>

        <div class="container-main">
            <!-- Tabs -->
            <div class="tabs-nav">
                <button class="tab-btn active" id="btnTabBorrow" onclick="switchTab('borrow')">ã€€æˆ‘è¦å€Ÿç”¨ã€€</button>
                <button class="tab-btn" id="btnTabReturn" onclick="switchTab('return')">ã€€æˆ‘è¦æ­¸é‚„ã€€</button>
            </div>

            <!-- å€Ÿç”¨åˆ†é  -->
            <div id="tab-borrow" class="tab-content active">
                <div class="borrow-split">
                    <div class="category-list" id="categoryList"></div>
                    <div class="items-area-wrapper">
                        <div class="items-area" id="itemsArea">
                            <div style="width:100%; text-align:center; color:#BDC3C7; margin-top:50px;">è«‹é¸æ“‡é¡åˆ¥</div>
                        </div>
                    </div>
                </div>

                <div class="cart-container" id="cartContainer">
                    <div class="cart-label">å¾…å€Ÿæ¸…å–® (é»å…©ä¸‹ç§»é™¤)</div>
                    <div class="cart-inner">
                        <div class="cart-table-wrap">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width:15%">é¡åˆ¥</th>
                                        <th style="width:30%">å“é …åç¨±</th>
                                        <th style="width:15%">è²¡ç”¢ç·¨è™Ÿ</th>
                                        <th style="width:10%">æ•¸é‡</th>
                                        <th style="width:30%">å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody id="cartBody"></tbody>
                            </table>
                        </div>
                        <div class="cart-actions">
                            <button class="btn btn-cart-confirm" onclick="submitBorrow()" id="btnBorrow">ç¢ºèªå€Ÿå‡º</button>
                            <button class="btn btn-cart-note" onclick="openNoteModal()" id="btnNote">å¡«å¯«å‚™è¨»</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¸é‚„åˆ†é  -->
            <div id="tab-return" class="tab-content">
                <div class="return-controls">
                    <span style="font-size: 13px;">è«‹é»é¸æ­¸é‚„ç‰©å“ (ç´…è‰²ä»£è¡¨å·²é€¾æœŸ)</span>
                    <button class="btn btn-blue" style="font-size: 12px;">é¡¯ç¤ºå…¨éƒ¨</button>
                </div>
                <div class="return-table-wrap" id="returnTableContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">æ™‚é–“</th>
                                <th style="width: 10%">å€Ÿç”¨äºº</th>
                                <th style="width: 20%">å“é …</th>
                                <th style="width: 10%">ç·¨è™Ÿ</th>
                                <th style="width: 5%">æ•¸é‡</th>
                                <th style="width: 15%">é è¨ˆæ­¸é‚„</th>
                                <th style="width: 15%">å‚™è¨»</th> 
                                <th style="width: 10%">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="returnBody">
                            <!-- æ¨¡æ“¬è³‡æ–™ -->
                        </tbody>
                    </table>
                </div>
                <div style="padding: 10px 0; display: flex; justify-content: flex-end;">
                     <!-- æŒ‰éˆ•å·²ç§»é™¤ -->
                     <button class="btn btn-success" style="width: 150px; font-size: 16px;" id="btnReturnConfirm" onclick="submitReturn()">ç¢ºèªæ­¸é‚„</button>
                </div>
            </div>

            <div class="footer">
                <button class="btn btn-logout" onclick="logout()">ç™»å‡º / é‡ç½®ç³»çµ±</button>
                <div class="signature">System Designed by Tyl</div>
            </div>
        </div>
    </div>

    <!-- Modal é®ç½© (å…±ç”¨) -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- å‚™è¨»è¼¸å…¥ Modal -->
    <div id="noteModal" class="modal-box">
        <h3>å¡«å¯«å‚™è¨»</h3>
        <input type="text" id="noteInput" placeholder="è«‹è¼¸å…¥å…§å®¹...">
        <div class="modal-footer">
            <button class="btn btn-blue" onclick="saveNote()">ç¢ºå®š</button>
            <button class="btn" style="background:#95A5A6; color:white;" onclick="closeModal('noteModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ—¥æœŸé¸æ“‡ Modal -->
    <div id="dateModal" class="modal-box">
        <h3>é¸æ“‡é è¨ˆæ­¸é‚„æ—¥æœŸ</h3>
        <div style="font-size:12px; color:#555; margin-bottom:5px;">è«‹é¸æ“‡æ‚¨é è¨ˆæ­¸é‚„è¨­å‚™çš„æ—¥æœŸï¼š</div>
        <input type="date" id="dateInput">
        <div class="modal-footer">
            <button class="btn btn-accent" onclick="confirmDate()">ç¢ºèªå€Ÿå‡º</button>
            <button class="btn" style="background:#95A5A6; color:white;" onclick="closeModal('dateModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Tutorial Tooltip -->
    <div class="tutorial-overlay" id="tutorialOverlay"></div>
    <div class="tooltip-box" id="tutorialTooltip">
        <div class="tooltip-title" id="ttTitle">æ¨™é¡Œ</div>
        <div class="tooltip-text" id="ttContent">å…§å®¹</div>
        <button class="tooltip-btn" onclick="nextTutorialStep()" id="ttBtn">ä¸‹ä¸€æ­¥</button>
    </div>

    <script>
        // --- Mock Data ---
        const MOCK_ITEMS = {
            "ç­†è¨˜å‹é›»è…¦": ["MacBook Pro 13", "MacBook Air M1", "ASUS ZenBook"],
            "å¹³æ¿é›»è…¦": ["iPad Pro 11", "iPad Air 5"],
            "è½‰æ¥ç·šæ": ["HDMI ç·š (3M)", "Type-C Hub", "VGA è½‰æ¥é ­"],
            "æ”å½±å™¨æ": ["Canon EOS R6", "Sony A7 IV"],
            "æ•™å®¤è€—æ": ["ç™½æ¿ç­†(é»‘)", "ç™½æ¿ç­†(ç´…)", "æ¿æ“¦"]
        };

        const MOCK_RETURN_DATA = [
            { time: "2023/11/20 09:30", user: "User", item: "MacBook Pro M2", id: "NB-001", qty: 1, due: "2023/11/21", note: "æ•™å­¸ç”¨", status: "é€¾æœŸ", overdue: true },
            { time: "2023/11/28 10:00", user: "User", item: "HDMI è½‰æ¥ç·š", id: "", qty: 1, due: "2023/11/28", note: "", status: "å€Ÿç”¨ä¸­", overdue: false }
        ];

        let cart = [];
        let selectedCartIndex = -1; 
        let selectedReturnIndex = -1; 
        
        let isTutorialMode = false;
        let tutorialStep = 0;

        // --- Init ---
        window.onload = function() {
            document.getElementById('loginInput').focus();
            initCategoryList();
            renderReturnTable();
            document.getElementById('dateInput').valueAsDate = new Date();
        };

        document.getElementById('loginInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { performLogin(this.value); }
        });

        // --- Borrow Logic ---
        function initCategoryList() {
            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            Object.keys(MOCK_ITEMS).forEach(cat => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                div.innerText = cat;
                div.onclick = () => selectCategory(cat, div);
                list.appendChild(div);
            });
        }

        function selectCategory(category, element) {
            document.querySelectorAll('.cat-item').forEach(el => el.classList.remove('selected'));
            if(element) element.classList.add('selected');

            const area = document.getElementById('itemsArea');
            area.innerHTML = '';
            const items = MOCK_ITEMS[category] || [];
            
            items.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'item-card';
                btn.innerText = item;
                btn.onclick = () => addToCart(category, item);
                area.appendChild(btn);
            });

            if (isTutorialMode && tutorialStep === 1) nextTutorialStep();
        }

        function addToCart(cat, item) {
            const id = (cat.includes('è€—æ') || cat.includes('ç·šæ')) ? '' : 'A' + Math.floor(Math.random() * 10000);
            cart.push({ cat, item, id, qty: 1, note: '' });
            renderCart();
            if (isTutorialMode && tutorialStep === 2) nextTutorialStep();
        }

        function renderCart() {
            const tbody = document.getElementById('cartBody');
            tbody.innerHTML = '';
            selectedCartIndex = -1; 

            cart.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.onclick = () => selectCartRow(idx, tr);
                tr.ondblclick = () => removeFromCart(idx);
                tr.innerHTML = `<td>${c.cat}</td><td>${c.item}</td><td>${c.id}</td><td>${c.qty}</td><td>${c.note}</td>`;
                tbody.appendChild(tr);
            });
        }

        function selectCartRow(idx, trElement) {
            selectedCartIndex = idx;
            const rows = document.getElementById('cartBody').querySelectorAll('tr');
            rows.forEach(r => r.classList.remove('selected-row'));
            trElement.classList.add('selected-row');
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
        }

        // --- Modal Logic ---
        function openNoteModal() {
            if (selectedCartIndex === -1) {
                alert("è«‹å…ˆé»é¸ä¸‹æ–¹æ¸…å–®ä¸­çš„ä¸€é …ç‰©å“ï¼Œå†å¡«å¯«å‚™è¨»ã€‚");
                return;
            }
            const currentNote = cart[selectedCartIndex].note;
            document.getElementById('noteInput').value = currentNote;
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('noteModal').style.display = 'block';
            document.getElementById('noteInput').focus();
        }

        function closeModal(modalId) {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById(modalId).style.display = 'none';
        }

        function saveNote() {
            const val = document.getElementById('noteInput').value;
            if (selectedCartIndex !== -1) {
                cart[selectedCartIndex].note = val;
                renderCart();
            }
            closeModal('noteModal');
            if (isTutorialMode && tutorialStep === 3) nextTutorialStep();
        }

        function submitBorrow() {
            if(cart.length === 0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");
            
            if (isTutorialMode && tutorialStep === 3) {
                 tutorialStep = 4;
            }

            // é–‹å•Ÿæ—¥æœŸé¸æ“‡ Modal
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('dateModal').style.display = 'block';
            
            if (isTutorialMode && tutorialStep === 4) {
                document.getElementById('tutorialTooltip').style.display = 'none';
            }
        }

        function confirmDate() {
            const dateVal = document.getElementById('dateInput').value;
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸï¼");
            
            closeModal('dateModal');
            
            // --- æ›´æ–°æ­¸é‚„åˆ—è¡¨ ---
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            const dueStr = dateVal.replace(/-/g, '/'); // æ­£è¦åŒ–æ—¥æœŸæ ¼å¼

            cart.forEach(c => {
                MOCK_RETURN_DATA.push({
                    time: timeStr,
                    user: "User",
                    item: c.item,
                    id: c.id,
                    qty: c.qty,
                    due: dueStr,
                    note: c.note,
                    status: "å€Ÿç”¨ä¸­",
                    overdue: false
                });
            });

            renderReturnTable();
            // ------------------

            alert(`å€Ÿç”¨æˆåŠŸï¼\né è¨ˆæ­¸é‚„æ—¥ï¼š${dateVal}\nè³‡æ–™å·²å¯«å…¥ç´€éŒ„è¡¨ã€‚`);
            cart = [];
            renderCart();

            if(isTutorialMode && tutorialStep === 4) {
                 document.getElementById('tutorialTooltip').style.display = 'block'; 
                 nextTutorialStep(); 
            }
        }

        // --- Return Logic ---
        function renderReturnTable() {
            const tbody = document.getElementById('returnBody');
            tbody.innerHTML = '';
            selectedReturnIndex = -1;

            MOCK_RETURN_DATA.forEach((data, idx) => {
                const tr = document.createElement('tr');
                const overdueClass = data.overdue ? 'overdue' : '';
                
                tr.onclick = () => selectReturnRow(idx, tr);
                
                tr.innerHTML = `
                    <td>${data.time}</td>
                    <td>${data.user}</td>
                    <td>${data.item}</td>
                    <td>${data.id}</td>
                    <td>${data.qty}</td>
                    <td class="${overdueClass}">${data.due}</td>
                    <td>${data.note}</td>
                    <td class="${overdueClass}">${data.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectReturnRow(idx, trElement) {
            selectedReturnIndex = idx;
            const rows = document.getElementById('returnBody').querySelectorAll('tr');
            rows.forEach(r => r.classList.remove('selected-row'));
            trElement.classList.add('selected-row');

            if(isTutorialMode && tutorialStep === 6) nextTutorialStep();
        }

        function submitReturn() {
            if(selectedReturnIndex === -1) return alert("è«‹å…ˆé»é¸è¦æ­¸é‚„çš„ç‰©å“ï¼");
            alert("æ­¸é‚„æˆåŠŸï¼");
            MOCK_RETURN_DATA.splice(selectedReturnIndex, 1);
            renderReturnTable();
            
            if(isTutorialMode) {
                endTutorial();
                alert("ğŸ“ æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰å€Ÿé‚„æ•™å­¸ã€‚");
            }
        }

        // --- System Logic ---
        function performLogin(val) {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
            }, 500);
        }

        function logout() {
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').style.opacity = '1';
            document.getElementById('loginInput').value = '';
            document.getElementById('loginInput').focus();
            cart = [];
            renderCart();
            // åªä¿ç•™å‰å…©ç­†é è¨­è³‡æ–™åšç‚ºé‡ç½®ç‹€æ…‹ (å¦‚æœéœ€è¦å®Œå…¨é‡ç½®å¯é‡æ–°å®£å‘Š)
            // é€™è£¡ç°¡å–®é‡æ•´ç¶²é æœ€å¿«
            if(MOCK_RETURN_DATA.length !== 2) location.reload(); 
            endTutorial();
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if(tab === 'borrow') {
                tabs[0].classList.add('active');
                document.getElementById('tab-borrow').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('tab-return').classList.add('active');
            }

            if(isTutorialMode && tutorialStep === 5 && tab === 'return') nextTutorialStep();
        }

        // --- Tutorial Logic ---
        const tutorialSteps = [
            {
                target: 'categoryList',
                title: 'æ­¥é©Ÿ 1: é¸æ“‡é¡åˆ¥',
                content: 'ç¾åœ¨ç•«é¢å·²è¢«é–å®šï¼Œæ‚¨åªèƒ½æ“ä½œæŒ‡å®šçš„æ­¥é©Ÿã€‚\nè«‹é»é¸å·¦å´çš„ä¸€å€‹é¡åˆ¥ (å¦‚: ç­†è¨˜å‹é›»è…¦)ã€‚',
                pos: 'right', hideBtn: true
            },
            {
                target: 'itemsArea',
                title: 'æ­¥é©Ÿ 2: é»é¸ç‰©å“',
                content: 'å³å´å‡ºç¾äº†è©²é¡åˆ¥çš„ç‰©å“ã€‚\nè«‹é»æ“ŠæŒ‰éˆ•å°‡ç‰©å“åŠ å…¥æ¸…å–®ã€‚',
                pos: 'left', hideBtn: true
            },
            {
                target: 'cartContainer',
                title: 'æ­¥é©Ÿ 3: å¡«å¯«å‚™è¨»',
                content: 'è«‹ã€Œé»é¸ã€ä¸‹æ–¹æ¸…å–®ä¸­çš„ç‰©å“ï¼Œç„¶å¾ŒæŒ‰å³é‚Šçš„ã€Œå¡«å¯«å‚™è¨»ã€ã€‚\n(æˆ–ç›´æ¥æŒ‰ã€Œç¢ºèªå€Ÿå‡ºã€è·³é)',
                pos: 'top', hideBtn: true
            },
            {
                target: 'btnBorrow',
                title: 'æ­¥é©Ÿ 4: ç¢ºèªèˆ‡æ—¥æœŸé¸æ“‡',
                content: 'è«‹æŒ‰ä¸‹ã€Œç¢ºèªå€Ÿå‡ºã€ï¼Œç³»çµ±æœƒè·³å‡ºæ—¥æœŸé¸å–®ï¼Œè«‹é¸æ“‡æ­¸é‚„æ—¥æœŸä¸¦ç¢ºèªã€‚',
                pos: 'left', hideBtn: true
            },
            {
                target: 'btnTabReturn',
                title: 'æ­¥é©Ÿ 5: åˆ‡æ›æ­¸é‚„é é¢',
                content: 'å€Ÿç”¨å®Œæˆï¼\næ¥ä¸‹ä¾†è«‹é»æ“Šä¸Šæ–¹çš„ã€Œæˆ‘è¦æ­¸é‚„ã€åˆ†é ã€‚',
                pos: 'bottom', hideBtn: true
            },
            {
                target: 'returnTableContainer',
                title: 'æ­¥é©Ÿ 6: é¸å–æ­¸é‚„ç‰©å“',
                content: 'è«‹é»æ“Šè¡¨æ ¼ä¸­çš„ä»»ä¸€é …ç›®ï¼Œå°‡å…¶åç™½é¸å–ã€‚',
                pos: 'top', hideBtn: true
            },
            {
                target: 'btnReturnConfirm',
                title: 'æ­¥é©Ÿ 7: ç¢ºèªæ­¸é‚„',
                content: 'é¸å–å¾Œï¼ŒæŒ‰ä¸‹å³ä¸‹è§’çš„ã€Œç¢ºèªæ­¸é‚„ã€æŒ‰éˆ•ï¼Œå³å¯å®Œæˆæ‰‹çºŒã€‚',
                pos: 'left', hideBtn: true
            }
        ];

        function startTutorial() {
            isTutorialMode = true;
            document.getElementById('loginInput').value = "A123456789";
            performLogin("A123456789");
            setTimeout(() => { tutorialStep = 1; showStep(0); }, 600);
        }

        function showStep(idx) {
            const step = tutorialSteps[idx];
            const targetEl = document.getElementById(step.target);
            const tooltip = document.getElementById('tutorialTooltip');
            const overlay = document.getElementById('tutorialOverlay');

            document.querySelectorAll('.highlight-target').forEach(e => e.classList.remove('highlight-target'));
            
            overlay.style.display = 'block';
            tooltip.style.display = 'block';
            
            targetEl.classList.add('highlight-target');

            document.getElementById('ttTitle').innerText = step.title;
            document.getElementById('ttContent').innerText = step.content;
            
            const btn = document.getElementById('ttBtn');
            btn.style.display = step.hideBtn ? 'none' : 'block';

            // Positioning
            const rect = targetEl.getBoundingClientRect();
            let top, left;

            if(step.pos === 'right') {
                top = rect.top; left = rect.right + 20;
            } else if (step.pos === 'left') {
                top = rect.top; left = rect.left - 320;
            } else if (step.pos === 'top') {
                top = rect.top - 150; left = rect.left + 50;
            } else if (step.pos === 'bottom') {
                top = rect.bottom + 20; left = rect.left;
            }
            
            if(top < 10) top = 10;
            if(left < 10) left = 10;
            
            tooltip.style.top = top + "px";
            tooltip.style.left = left + "px";
        }

        function nextTutorialStep() {
            tutorialStep++;
            const idx = tutorialStep - 1;
            if(idx < tutorialSteps.length) showStep(idx);
            else endTutorial();
        }

        function endTutorial() {
            isTutorialMode = false;
            tutorialStep = 0;
            document.getElementById('tutorialOverlay').style.display = 'none';
            document.getElementById('tutorialTooltip').style.display = 'none';
            document.querySelectorAll('.highlight-target').forEach(e => e.classList.remove('highlight-target'));
        }
    </script>
</body>
</html>
